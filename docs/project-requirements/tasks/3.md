# Task 3: Implement Mastra AI Agents for Brand and Supplier Negotiations

**Dependencies:** Task 1, Task 14

### Goal
Create Mastra AI agents for brand and supplier negotiations using the Mastra framework with proper system prompts, tools, and conversation management.

### Implementation Context
**Files to Create:**
- `src/mastra/agents/brand-agent.ts`
- `src/mastra/agents/supplier-agent.ts`
- `src/mastra/tools/negotiation-tools.ts`

**Files to Modify:**
- `package.json` (add Mastra dependencies)

**Key Requirements:**
- Brand agent aware of supplier quality ratings (Supplier 1: 4.0, Supplier 2: 4.7, Supplier 3: 4.0)
- Supplier agents have distinct characteristics (pricing, speed, payment terms)
- Dynamic negotiation rounds until agreement or impasse
- Natural English language communication
- API keys stored securely in environment variables

**Technical Notes:**
- Use `@mastra/core` for Agent class and createTool
- Use `@ai-sdk/openai` for OpenAI model provider
- Use Zod for input/output schema validation
- Each agent has distinct `instructions` defining their role and constraints
- Tools enable structured negotiation actions (propose, counter, accept, reject)

**Mastra Agent Pattern:**
```typescript
import { openai } from "@ai-sdk/openai";
import { Agent } from "@mastra/core/agent";

export const brandAgent = new Agent({
  name: "Brand Negotiation Agent",
  description: "AI agent representing the brand in supplier negotiations",
  instructions: `You are a professional buyer representing the brand...`,
  model: openai("gpt-4o"),
  tools: { proposeTool, counterOfferTool, acceptTool, rejectTool },
});
```

### Scope Definition
**Deliverables:**
- `brandAgent`: Mastra Agent representing the brand's interests with tools for negotiation
- `createSupplierAgent(supplierId)`: Factory function to create supplier agents with distinct characteristics
- Negotiation tools: `proposeTool`, `counterOfferTool`, `acceptOfferTool`, `rejectOfferTool`
- System prompts for brand agent (with quality ratings, user priorities)
- System prompts for each supplier agent (with characteristics and flexibility)

**Agent Characteristics:**

| Supplier | Quality | Pricing | Speed | Payment Terms |
|----------|---------|---------|-------|---------------|
| 1        | 4.0     | Cheapest | Slow | 33/33/33 |
| 2        | 4.7     | Premium | Medium-Fast | 30/70 |
| 3        | 4.0     | Expensive | Fastest | 30/70 |

**Exclusions:**
- Real-time streaming responses (deferred)
- Learning from past negotiations (deferred)
- Multi-language support (English only)
- Workflow orchestration (Task 15)

### Implementation Steps

1. **Install Mastra dependencies:**
   ```bash
   pnpm add @mastra/core @ai-sdk/openai zod
   ```

2. **Create negotiation tools** (`src/mastra/tools/negotiation-tools.ts`):
   - `proposeTool`: Submit initial offer with price, lead time, payment terms
   - `counterOfferTool`: Counter with modified terms
   - `acceptOfferTool`: Accept current offer terms
   - `rejectOfferTool`: Reject offer with reason

3. **Create Brand Agent** (`src/mastra/agents/brand-agent.ts`):
   - Instructions include: role as brand representative, supplier quality ratings, user priorities, negotiation objectives
   - Tools: all negotiation tools
   - Model: `openai("gpt-4o")`

4. **Create Supplier Agent Factory** (`src/mastra/agents/supplier-agent.ts`):
   - `createSupplierAgent(supplierId: 1 | 2 | 3)`: Returns Agent with supplier-specific instructions
   - Instructions include: supplier characteristics, negotiation flexibility, material substitution options
   - Each supplier has different pricing strategies and constraints

5. **Define input/output schemas** with Zod:
   ```typescript
   const offerSchema = z.object({
     unitPrice: z.number(),
     leadTimeDays: z.number(),
     paymentTerms: z.string(),
     notes: z.string().optional(),
   });
   ```

6. **Test: Brand agent generates negotiation message**
   - **Setup:** New negotiation with user priorities (quality: 40%, cost: 30%, lead_time: 20%, payment: 10%)
   - **Action:** Call `brandAgent.generate()` with initial context
   - **Expect:** Returns message mentioning quality importance and requesting supplier terms

7. **Test: Supplier agent responds appropriately**
   - **Setup:** Supplier 2 (high quality) with brand message requesting pricing
   - **Action:** Call supplier agent `generate()` with brand message
   - **Expect:** Returns message highlighting quality rating 4.7 and proposing premium pricing

### Success Criteria
- Brand agent generates contextually appropriate negotiation messages using Mastra Agent.generate()
- Each supplier agent responds with personality matching their characteristics
- Negotiation tools have proper Zod schemas for input/output validation
- System prompts produce natural business language
- All agents handle errors gracefully with Mastra's built-in error handling
- TypeScript types are fully inferred from Zod schemas

### Scope Constraint
Implement only the AI agent definitions. Do not implement the orchestration logic that coordinates multiple negotiations (Task 15).
