# Task 6: Create Convex queries for fetching quotes, negotiations, messages, and decisions

**Dependencies:** Task 1

### Goal
Implement read-only Convex queries to fetch data for the UI, including quote details, negotiation status, conversation history, and decision results.

### Implementation Context
**Files to Modify:**
- `src/server/quotes.ts` (add queries)
- `src/server/negotiations.ts` (add queries)
- `src/server/decisions.ts` (add queries)

**Key Requirements:**
- Fetch quote by ID with all details
- Fetch all negotiations for a quote with message history
- Fetch messages for a specific negotiation ordered by timestamp
- Fetch decision for a quote with evaluation scores
- Support real-time updates via Convex reactivity

**Technical Notes:**
- Use `query()` function from Convex (read-only, reactive)
- Follow existing query pattern from `src/server/users.ts`
- Use indexes for efficient lookups (by_quote_id, by_negotiation_id)
- Return nested data structures for UI convenience
- Queries automatically re-run when data changes (Convex reactivity)

### Scope Definition
**Deliverables:**
- `getQuote` query: returns quote by ID with products, priorities, status
- `getQuoteNegotiations` query: returns all negotiations for a quote with messages
- `getNegotiationMessages` query: returns messages for a negotiation ordered by timestamp
- `getQuoteDecision` query: returns decision with evaluation scores
- `listQuotes` query: returns all quotes for past negotiations view

**Exclusions:**
- Complex filtering or search (out of scope)
- Pagination for large datasets (out of scope for MVP)

### Implementation Steps
1. Add `getQuote` query to `src/server/quotes.ts` with quote_id argument, return full quote record
2. Add `getQuoteNegotiations` query that fetches all negotiations for a quote using `by_quote_id` index
3. For each negotiation, fetch messages using `by_negotiation_id` index, order by timestamp ascending
4. Return nested structure: `{ negotiations: [{ negotiation, messages: [...] }] }`
5. Add `getNegotiationMessages` query with negotiation_id argument, return ordered messages
6. Add `getQuoteDecision` query with quote_id argument, fetch decision using `by_quote_id` index
7. Add `listQuotes` query that returns all quotes ordered by created_at descending
8. **Test: getQuoteNegotiations returns nested structure**
   - **Setup:** Quote with 3 negotiations, each with 4 messages
   - **Action:** Call getQuoteNegotiations with quote_id
   - **Expect:** Returns array of 3 negotiations, each with messages array ordered by timestamp
9. **Test: Queries react to data changes**
   - **Setup:** Subscribe to getQuoteNegotiations query
   - **Action:** Add new message to negotiation
   - **Expect:** Query automatically re-runs and returns updated data

### Success Criteria
- All queries return correct data structures
- Nested queries efficiently fetch related data
- Messages ordered chronologically within negotiations
- Queries leverage indexes for performance
- Real-time updates work via Convex reactivity
- No N+1 query problems

### Scope Constraint
Implement only read queries. Do not implement write operations or complex aggregations.