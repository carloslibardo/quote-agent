# Task 5: Implement decision evaluation action with weighted scoring algorithm

**Dependencies:** Task 4

### Goal
Create the decision evaluation logic that analyzes all supplier offers, applies user-defined priority weights, and selects the optimal supplier with clear reasoning.

### Implementation Context
**Files to Modify:**
- `src/server/decisions.ts` (new)

**Key Requirements:**
- Evaluate suppliers on four criteria: quality rating, total cost, lead time, payment terms
- Apply user-defined priority weights from quote request
- Calculate weighted scores for each supplier
- Select supplier with highest total score
- Generate human-readable explanation of decision rationale
- Save decision to database with evaluation scores

**Technical Notes:**
- Use Convex action to call OpenAI for generating reasoning explanation
- Extract final offers from negotiation message history
- Normalize scores to 0-100 scale for each criterion
- Quality: direct from supplier data (4.0 or 4.7 â†’ 80 or 94)
- Cost: inverse relationship (lower cost = higher score)
- Lead time: inverse relationship (faster = higher score)
- Payment terms: evaluate cash flow impact (33/33/33 better than 30/70)

**Simplicity Decisions:**
- Simple weighted sum algorithm instead of complex multi-criteria decision analysis
- Fixed supplier characteristics rather than dynamic offer parsing
- Single decision per quote (no revision mechanism)

### Scope Definition
**Deliverables:**
- `evaluateSuppliers` action: analyzes all negotiations, calculates scores, selects winner
- Scoring algorithm for each criterion with normalization
- Weighted score calculation using user priorities
- Reasoning generation using OpenAI
- Decision record creation with full evaluation breakdown

**Exclusions:**
- What-if analysis or alternative scenarios (out of scope)
- Manual override of AI decision (out of scope)

### Implementation Steps
1. Create `src/server/decisions.ts` with action imports
2. Implement `evaluateSuppliers` action that fetches all completed negotiations for a quote
3. Extract final offers from each negotiation's message history
4. Calculate quality score: supplier quality rating / 5.0 * 100
5. Calculate cost score: (max_cost - supplier_cost) / (max_cost - min_cost) * 100
6. Calculate lead time score: inverse of delivery days normalized to 0-100
7. Calculate payment terms score: evaluate cash flow impact (earlier payments = higher score)
8. Apply user priority weights: total_score = (quality * weight_q) + (cost * weight_c) + (lead_time * weight_lt) + (payment * weight_pt)
9. Select supplier with highest total_score
10. Call OpenAI to generate reasoning explanation based on scores and priorities
11. Insert decision record with selected_supplier_id, reasoning, evaluation_scores object
12. **Test: Decision selects supplier with highest weighted score**
   - **Setup:** 3 completed negotiations, user priorities (quality: 50%, cost: 30%, lead_time: 10%, payment: 10%)
   - **Action:** Call evaluateSuppliers
   - **Expect:** Supplier 2 (high quality 4.7) selected due to quality weight, reasoning mentions quality priority
13. **Test: Cost-focused priorities select cheapest supplier**
   - **Setup:** 3 completed negotiations, user priorities (cost: 70%, quality: 10%, lead_time: 10%, payment: 10%)
   - **Action:** Call evaluateSuppliers
   - **Expect:** Supplier 1 (cheapest) selected, reasoning explains cost optimization

### Success Criteria
- Scoring algorithm correctly evaluates all four criteria
- User priority weights properly applied to final scores
- Supplier with highest weighted score consistently selected
- Reasoning explanation clearly articulates decision rationale
- Decision record saved with complete evaluation breakdown
- Edge cases handled (tied scores, missing data)

### Scope Constraint
Implement only decision evaluation and selection. Do not implement UI display logic.