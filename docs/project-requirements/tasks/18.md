# Task 18: Environment Validation and Startup Checks

**Dependencies:** None

### Goal
Ensure the application fails fast with clear, actionable error messages if required environment variables are missing or invalid.

### Implementation Context
**Files to Create:**
- `src/env.ts` (already created)

**Files to Modify:**
- `src/main.tsx` - Import env to trigger validation on startup
- `vite.config.ts` - Configure environment variable handling

**Key Requirements:**
- Validate OPENAI_API_KEY is present and non-empty
- Support both Vite (client) and Node.js (server) environments
- Provide clear error messages with instructions
- Export typed environment object for use throughout app

**Technical Notes:**
- Use Zod for schema validation
- Vite requires VITE_ prefix for client-side env vars
- Convex actions use server-side env vars (no VITE_ prefix)
- Validation runs at module import time

**Environment Variables:**

| Variable | Required | Description | Used In |
|----------|----------|-------------|---------|
| VITE_OPENAI_API_KEY | Yes | OpenAI API key for client | Mastra agents |
| OPENAI_API_KEY | Yes | OpenAI API key for server | Convex actions |
| VITE_CONVEX_DEPLOYMENT | No | Convex deployment URL | Production only |

### Scope Definition
**Deliverables:**
- `src/env.ts`: Zod-based environment validation
- Import in `src/main.tsx` for startup validation
- Clear error messages for missing variables
- TypeScript types for env access
- `.env.example` with documentation

**Exclusions:**
- Runtime environment switching
- Secret rotation
- Environment encryption

### Implementation Steps

1. **Create env.ts** (completed):
   ```typescript
   import { z } from "zod";

   const envSchema = z.object({
     OPENAI_API_KEY: z.string().min(1, "OPENAI_API_KEY is required"),
     CONVEX_DEPLOYMENT: z.string().optional(),
     MODE: z.enum(["development", "production", "test"]).default("development"),
   });

   function validateEnv() {
     const envVars = typeof import.meta !== "undefined" && import.meta.env
       ? {
           OPENAI_API_KEY: import.meta.env.VITE_OPENAI_API_KEY,
           CONVEX_DEPLOYMENT: import.meta.env.VITE_CONVEX_DEPLOYMENT,
           MODE: import.meta.env.MODE,
         }
       : process.env;

     const result = envSchema.safeParse(envVars);

     if (!result.success) {
       const errorMessages = result.error.errors
         .map((err) => `  - ${err.path.join(".")}: ${err.message}`)
         .join("\n");

       throw new Error(
         `\n‚ùå Invalid environment variables:\n${errorMessages}\n\n` +
         `Please check your .env file. See .env.example for required variables.\n`
       );
     }

     return result.data;
   }

   export const env = validateEnv();
   export type Env = z.infer<typeof envSchema>;
   ```

2. **Import in main.tsx:**
   ```typescript
   // At the top of src/main.tsx
   import "./env"; // Validates environment on startup
   ```

3. **Create .env.example** (completed):
   ```bash
   # OpenAI API Key (required)
   VITE_OPENAI_API_KEY=sk-your-openai-api-key-here
   OPENAI_API_KEY=sk-your-openai-api-key-here
   
   # Convex deployment (optional in dev)
   VITE_CONVEX_DEPLOYMENT=
   ```

4. **Update .gitignore** to ensure .env is not committed

5. **Test: App fails with missing OPENAI_API_KEY**
   - **Setup:** Remove VITE_OPENAI_API_KEY from .env
   - **Action:** Run `pnpm dev`
   - **Expect:** Clear error message with instructions

6. **Test: App starts with valid environment**
   - **Setup:** Valid .env file with all required variables
   - **Action:** Run `pnpm dev`
   - **Expect:** App starts without errors

### Success Criteria
- App throws clear error if OPENAI_API_KEY is missing
- Error message includes instructions for fixing
- Valid environment allows app to start
- TypeScript types are exported for env access
- .env.example documents all required variables

### Scope Constraint
Implement only environment validation. Do not implement runtime configuration changes or secret management.

