# Task 9: Build active negotiation view with accordion UI and real-time message display

**Dependencies:** Tasks 6, 8

### Goal
Create the active negotiation screen displaying three supplier conversations in an accordion layout with real-time message updates and user intervention capabilities.

### Implementation Context
**Files to Modify:**
- `src/features/quotes/useCases/NegotiationPage.tsx` (new)
- `src/features/quotes/ui/NegotiationAccordion.tsx` (new)
- `src/features/quotes/ui/ConversationMessages.tsx` (new)
- `src/features/quotes/ui/InterventionInput.tsx` (new)
- `src/App.tsx` (add route)

**Key Requirements:**
- Display quote summary header (products, quantities, priorities)
- Accordion with three sections (one per supplier)
- Each section shows supplier name, characteristics, conversation messages, status
- Messages display sender (brand/supplier/user), content, timestamp
- Intervention input for active negotiations only
- Real-time updates as AI agents exchange messages
- Auto-scroll to latest message

**Technical Notes:**
- Use existing Accordion component from `src/shared/components/ui/accordion.tsx`
- Use Convex query with React Query for real-time data (getQuoteNegotiations)
- Convex reactivity automatically updates UI when new messages arrive
- Use useEffect with ref for auto-scroll to bottom of message list
- Disable intervention input when negotiation status is "completed" or "impasse"
- Follow DDD structure: features/quotes/useCases, features/quotes/ui

**Simplicity Decisions:**
- Polling via Convex reactivity instead of WebSocket streaming
- Simple message list instead of chat bubble UI
- No message editing or deletion

### Scope Definition
**Deliverables:**
- NegotiationPage component with quote summary and accordion
- NegotiationAccordion component managing three supplier sections
- ConversationMessages component displaying message history
- InterventionInput component for user messages
- Real-time message updates via Convex query
- Auto-scroll to latest message
- Route added to App.tsx

**Exclusions:**
- Message search or filtering (out of scope)
- Conversation export (out of scope)
- Typing indicators (out of scope)

### Implementation Steps
1. Create `src/features/quotes/useCases/NegotiationPage.tsx` with quote_id from route params
2. Fetch quote and negotiations using getQuoteNegotiations query
3. Display quote summary header: products, quantities, decision priorities
4. Create `src/features/quotes/ui/NegotiationAccordion.tsx` with Accordion component
5. Map three negotiations to AccordionItem components (Supplier 1, 2, 3)
6. Create `src/features/quotes/ui/ConversationMessages.tsx` to display messages
7. Show sender badge (Brand/Supplier/User), message content, timestamp for each message
8. Implement auto-scroll: useEffect with scrollIntoView on message list ref when messages change
9. Create `src/features/quotes/ui/InterventionInput.tsx` with textarea and "Send" button
10. Disable intervention input if negotiation status is not "active"
11. On send, call addUserIntervention mutation with negotiation_id and message
12. Add route to `src/App.tsx`: `/quotes/:quoteId/negotiations` â†’ NegotiationPage
13. Style with Tailwind CSS for responsive layout
14. **Test: Real-time message updates appear automatically**
   - **Setup:** Active negotiation with 2 messages
   - **Action:** Backend adds new message to negotiation
   - **Expect:** New message appears in UI without manual refresh
15. **Test: Intervention input disabled for completed negotiations**
   - **Setup:** Negotiation with status "completed"
   - **Action:** View negotiation in accordion
   - **Expect:** Intervention input disabled with message "Negotiation complete"

### Success Criteria
- Quote summary displays all relevant information
- Three accordion sections show supplier conversations
- Messages display correctly with sender identification
- Real-time updates work via Convex reactivity
- Auto-scroll keeps latest message visible
- User intervention successfully adds messages
- Intervention disabled for non-active negotiations
- Responsive layout on mobile and desktop

### Scope Constraint
Implement only negotiation view. Do not implement decision panel or past negotiations list.