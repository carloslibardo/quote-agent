# Task 2: Create Convex mutations for quote creation and management

**Dependencies:** Task 1

### Goal
Implement Convex mutations for creating and managing quote requests with validation.

### Implementation Context
**Files to Modify:**
- `src/server/quotes.ts` (new)

**Tests to Update:**
- `src/server/quotes.test.ts` (new - if testing framework exists)

**Key Requirements:**
- Create quote mutation validates at least one product has quantity > 0
- Decision priorities must sum to 100% (or be normalized)
- Quote status transitions: pending → negotiating → completed/cancelled
- User notes are optional with max 500 character limit
- Return quote_id on successful creation

**Technical Notes:**
- Follow existing mutation pattern from `src/server/users.ts`
- Use `v.object()` for nested validation of products array and decision_priorities
- Implement validation logic in mutation handler before database insert
- Use `ctx.db.insert()` for creating new quotes
- Use `ctx.db.patch()` for status updates

### Scope Definition
**Deliverables:**
- `createQuote` mutation: accepts products, user_notes, decision_priorities; returns quote_id
- `startNegotiation` mutation: updates quote status from pending to negotiating
- `cancelQuote` mutation: updates quote status to cancelled
- Input validation for all mutations

**Exclusions:**
- Negotiation creation logic (handled in separate task)
- Decision generation (handled by AI agent)

### Implementation Steps
1. Create `src/server/quotes.ts` file with Convex imports
2. Implement `createQuote` mutation with argument validators for products array, optional user_notes, decision_priorities object
3. Add validation: check at least one product quantity > 0, user_notes max 500 chars
4. Insert quote with status "pending", created_at timestamp, auto-generated user_id (or from context)
5. Implement `startNegotiation` mutation to update quote status to "negotiating"
6. Implement `cancelQuote` mutation to update quote status to "cancelled"
7. **Test: Create quote with valid data**
   - **Setup:** Valid products array, decision priorities summing to 100%
   - **Action:** Call createQuote mutation
   - **Expect:** Quote created with status "pending", returns quote_id
8. **Test: Validation error for empty products**
   - **Setup:** Products array with all quantities = 0
   - **Action:** Call createQuote mutation
   - **Expect:** Error thrown with message "At least one product must have quantity > 0"

### Success Criteria
- createQuote mutation successfully creates quotes with valid data
- Validation errors thrown for invalid inputs (empty products, notes too long)
- startNegotiation mutation transitions quote from pending to negotiating
- cancelQuote mutation sets status to cancelled
- All mutations return appropriate data or error messages

### Scope Constraint
Implement only quote CRUD mutations. Do not implement negotiation or message logic.