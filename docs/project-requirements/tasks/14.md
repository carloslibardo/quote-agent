# Task 14: Create Mastra Instance and Agent Registry

**Dependencies:** None (foundational task)

### Goal
Set up the central Mastra instance that registers all agents, tools, workflows, and storage for the quote negotiation platform.

### Implementation Context
**Files to Create:**
- `src/mastra/index.ts` - Main Mastra instance
- `src/mastra/agents/index.ts` - Agent exports
- `src/mastra/tools/index.ts` - Tool exports
- `src/mastra/workflows/index.ts` - Workflow exports

**Key Requirements:**
- Single Mastra instance for the entire application
- Centralized registration of agents, tools, and workflows
- Storage configuration for conversation persistence
- Environment variable validation before initialization

**Technical Notes:**
- Use `Mastra` class from `@mastra/core`
- Use `LibSQLStore` from `@mastra/libsql` for storage (or custom Convex adapter)
- Import and register all agents, tools, and workflows
- Export mastra instance for use throughout the app

**Mastra Instance Pattern:**
```typescript
import { Mastra } from "@mastra/core";
import { LibSQLStore } from "@mastra/libsql";

import { brandAgent, supplierAgent1, supplierAgent2, supplierAgent3 } from "./agents";
import { negotiationWorkflow } from "./workflows";

export const mastra = new Mastra({
  storage: new LibSQLStore({
    url: "file:./mastra.db",
  }),
  agents: { brandAgent, supplierAgent1, supplierAgent2, supplierAgent3 },
  workflows: { negotiationWorkflow },
});
```

### Scope Definition
**Deliverables:**
- `src/mastra/index.ts`: Main Mastra instance with all registrations
- `src/mastra/agents/index.ts`: Re-exports all agents
- `src/mastra/tools/index.ts`: Re-exports all tools
- `src/mastra/workflows/index.ts`: Re-exports all workflows
- Storage configuration for local development

**Exclusions:**
- Agent implementation (Task 3)
- Tool implementation (Tasks 3, 16, 17)
- Workflow implementation (Task 15)
- Production storage configuration (Task 19)

### Implementation Steps

1. **Create directory structure:**
   ```
   src/mastra/
   ├── index.ts
   ├── agents/
   │   └── index.ts
   ├── tools/
   │   └── index.ts
   └── workflows/
       └── index.ts
   ```

2. **Create placeholder exports** for agents, tools, workflows:
   - Initially export empty objects or placeholder implementations
   - Will be populated as Tasks 3, 15, 16, 17 are completed

3. **Create main Mastra instance** (`src/mastra/index.ts`):
   ```typescript
   import { Mastra } from "@mastra/core";
   import { LibSQLStore } from "@mastra/libsql";
   
   import { agents } from "./agents";
   import { workflows } from "./workflows";
   
   export const mastra = new Mastra({
     storage: new LibSQLStore({
       url: "file:./mastra.db",
     }),
     agents,
     workflows,
   });
   ```

4. **Add environment check** at module load:
   ```typescript
   import { env } from "../env";
   
   // Validates env vars before initializing Mastra
   console.log("Initializing Mastra with OpenAI...");
   ```

5. **Test: Mastra instance initializes successfully**
   - **Setup:** Valid environment variables
   - **Action:** Import mastra instance
   - **Expect:** No errors, instance is defined

6. **Test: Agent retrieval works**
   - **Setup:** Mastra instance with registered agents
   - **Action:** Call `mastra.getAgent("brandAgent")`
   - **Expect:** Returns brand agent instance

### Success Criteria
- Mastra instance initializes without errors
- All agents are retrievable via `mastra.getAgent()`
- All workflows are retrievable via `mastra.getWorkflow()`
- Storage is properly configured
- Environment variables are validated before initialization

### Scope Constraint
Implement only the Mastra instance setup and registration. Agent and workflow implementations are in separate tasks.

